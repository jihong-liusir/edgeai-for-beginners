<!--
CO_OP_TRANSLATOR_METADATA:
{
  "original_hash": "382a763fcea7087e68a94c26216e5e70",
  "translation_date": "2025-09-22T22:36:35+00:00",
  "source_file": "Module08/05.AIPoweredAgents.md",
  "language_code": "ms"
}
-->
# Sesi 5: Bina Ejen Berkuasa AI dengan Cepat menggunakan Foundry Local

Nota: Keupayaan ejen dalam Foundry Local berkembangâ€”sahkan sokongan dalam nota keluaran terkini sebelum melaksanakan corak lanjutan.

## Gambaran Keseluruhan

Gunakan Foundry Local untuk prototaip aplikasi ejen dengan pantas: arahan sistem, asas data, dan corak orkestrasi. Apabila sokongan ejen tersedia, anda boleh menstandardkan pada panggilan fungsi yang serasi dengan OpenAI atau menggunakan Azure AI Agents di bahagian awan dalam reka bentuk hibrid.

Rujukan:
- Dokumentasi Foundry Local: https://learn.microsoft.com/en-us/azure/ai-foundry/foundry-local/
- Azure AI Foundry Agents: https://learn.microsoft.com/en-us/azure/ai-services/agents/overview
- Contoh panggilan fungsi (contoh Foundry Local): https://github.com/microsoft/Foundry-Local/tree/main/samples/python/functioncalling

## Objektif Pembelajaran
- Reka bentuk arahan sistem dan strategi asas untuk tingkah laku yang boleh dipercayai
- Laksanakan corak panggilan fungsi (penggunaan alat)
- Orkestrasi aliran kerja multi-ejen (tempatan dan hibrid)
- Rancang untuk pemerhatian dan keselamatan

## Bahagian 1: Arahan Sistem dan Asas Data

- Tentukan peranan, kekangan, dan skema output yang ketat
- Asaskan respons dengan data tempatan atau data perusahaan
- Paksa output JSON untuk automasi hiliran

## Bahagian 2: Panggilan Fungsi (Serasi dengan OpenAI)

```python
# tools.py
import json

def get_weather(city: str) -> str:
    return f"Weather in {city}: Sunny, 25C"

FUNCTIONS = [
    {
        "name": "get_weather",
        "description": "Get current weather for a city",
        "parameters": {
            "type": "object",
            "properties": {
                "city": {"type": "string", "description": "City name"}
            },
            "required": ["city"]
        }
    }
]
```

```python
# agent.py
import requests
import json
from tools import FUNCTIONS, get_weather

BASE_URL = "http://localhost:8000"
MODEL = "phi-4-mini"

SYSTEM_PROMPT = "You are a helpful assistant. Use tools when needed."

def call_model(messages, functions=None):
    payload = {
        "model": MODEL,
        "messages": messages,
        "functions": functions,
        "function_call": "auto"
    }
    r = requests.post(f"{BASE_URL}/v1/chat/completions", json=payload, timeout=60)
    r.raise_for_status()
    return r.json()

messages = [{"role": "system", "content": SYSTEM_PROMPT},
            {"role": "user", "content": "What's the weather in Paris?"}]

resp = call_model(messages, functions=FUNCTIONS)
choice = resp["choices"][0]["message"]

if "function_call" in choice:
    fc = choice["function_call"]
    if fc["name"] == "get_weather":
        args = json.loads(fc["arguments"])
        result = get_weather(args["city"])
        messages.append(choice)
        messages.append({"role": "function", "name": "get_weather", "content": result})
        final = call_model(messages)
        print(final["choices"][0]["message"]["content"]) 
else:
    print(choice.get("content"))
```

Jalankan:
```powershell
# Ensure a model is running
foundry model run phi-4-mini
python agent.py
```


## Bahagian 3: Orkestrasi Multi-Ejen (Corak)

Reka bentuk penyelaras yang mengarahkan tugas kepada ejen pakar (pengambilan, penaakulan, pelaksanaan) menggunakan titik akhir Foundry Local yang serasi dengan OpenAI.

Langkah 1) Tentukan ejen pakar  
```python
# agents/specialists.py
import requests
BASE_URL = "http://localhost:8000"
MODEL = "phi-4-mini"

headers = {"Content-Type": "application/json", "Authorization": "Bearer local-key"}

def chat(messages, max_tokens=300, temperature=0.4):
    r = requests.post(f"{BASE_URL}/v1/chat/completions", json={
        "model": MODEL,
        "messages": messages,
        "max_tokens": max_tokens,
        "temperature": temperature
    }, headers=headers, timeout=60)
    r.raise_for_status()
    return r.json()["choices"][0]["message"]["content"]

class RetrievalAgent:
    SYSTEM = "You retrieve relevant snippets from knowledge sources based on a query."
    def run(self, query: str) -> str:
        # Placeholder: in real use, fetch from local files or vector DB
        messages = [{"role": "system", "content": self.SYSTEM},
                    {"role": "user", "content": f"Retrieve key facts for: {query}"}]
        return chat(messages)

class ReasoningAgent:
    SYSTEM = "You analyze inputs step by step and produce structured conclusions."
    def run(self, context: str, question: str) -> str:
        messages = [
            {"role": "system", "content": self.SYSTEM},
            {"role": "user", "content": f"Context:\n{context}\n\nQuestion: {question}\nThink step-by-step and produce a concise answer."}
        ]
        return chat(messages)

class ExecutionAgent:
    SYSTEM = "You transform decisions into actionable steps (JSON with actions)."
    def run(self, decision: str) -> str:
        messages = [
            {"role": "system", "content": self.SYSTEM},
            {"role": "user", "content": f"Turn this decision into 3 executable steps as JSON:\n{decision}"}
        ]
        return chat(messages)
```
  
Langkah 2) Bina penyelaras  
```python
# agents/coordinator.py
from agents.specialists import RetrievalAgent, ReasoningAgent, ExecutionAgent

class Coordinator:
    def __init__(self):
        self.retrieval = RetrievalAgent()
        self.reasoning = ReasoningAgent()
        self.execution = ExecutionAgent()

    def handle(self, user_goal: str) -> dict:
        # 1. Retrieve context
        context = self.retrieval.run(user_goal)
        # 2. Reason on context
        decision = self.reasoning.run(context, user_goal)
        # 3. Produce actionable steps
        actions = self.execution.run(decision)
        return {
            "goal": user_goal,
            "context": context,
            "decision": decision,
            "actions": actions
        }

if __name__ == "__main__":
    # Ensure: foundry model run phi-4-mini
    coord = Coordinator()
    result = coord.handle("Create a plan to onboard 5 new customers this month")
    print(result)
```
  
Langkah 3) Sahkan terhadap Foundry Local  
```powershell
REM Confirm the local endpoint and model are available
foundry model list
foundry model run phi-4-mini
curl http://localhost:8000/v1/models

REM Run the coordinator
python -m samples.05.agents.coordinator
```
  

Panduan:
- Laksanakan percubaan semula dan had masa antara ejen
- Tambahkan stor kecil dalam memori (dict) untuk keadaan perbualan/benang
- Perkenalkan had kadar apabila menghubungkan beberapa panggilan

## Bahagian 4: Pemerhatian dan Keselamatan

Jejak arahan, respons, dan ralat secara tempatan, sambil menguatkuasakan kebersihan data dalam tumpukan ejen anda.

Langkah 1) Log permintaan ringan (pilihan)

Nota: Pembantu berikut tidak disertakan secara lalai. Buat `infra/obs.py` jika anda ingin log JSON tempatan untuk eksperimen.  
```python
# infra/obs.py
import time, json, os
from datetime import datetime

LOG_DIR = os.getenv("FOUNDRY_AGENT_LOG_DIR", "./agent_logs")
os.makedirs(LOG_DIR, exist_ok=True)

def log_event(kind: str, payload: dict):
    ts = datetime.utcnow().strftime("%Y%m%dT%H%M%SZ")
    path = os.path.join(LOG_DIR, f"{ts}_{kind}.json")
    with open(path, "w", encoding="utf-8") as f:
        json.dump(payload, f, ensure_ascii=False, indent=2)
```
  
Integrasikan log ke dalam ejen (pilihan):  
```python
# in agents/specialists.py after receiving content
from infra.obs import log_event
# ... inside chat(...)
resp = r.json()
log_event("chat_request", {"endpoint": f"{BASE_URL}/v1/chat/completions"})
log_event("chat_response", resp)
return resp["choices"][0]["message"]["content"]
```
  

Langkah 2) Sahkan ketersediaan dan kesihatan asas melalui CLI  
```powershell
REM Ensure Foundry Local is running a model
foundry model list
foundry model run phi-4-mini

REM Validate the OpenAI-compatible endpoint
curl http://localhost:8000/v1/models
```
  

Langkah 3) Penyuntingan dan kebersihan PII  
- Sebelum menghantar mesej kepada model, buang atau hash medan sensitif (emel, nombor telefon, ID)  
- Simpan data sumber mentah pada peranti, hanya hantarkan rentetan konteks yang diperlukan  

Contoh pembantu penyuntingan:  
```python
# infra/redact.py
import re
EMAIL_RE = re.compile(r"[\w\.-]+@[\w\.-]+")
PHONE_RE = re.compile(r"\+?\d[\d\s\-]{7,}\d")

def sanitize(text: str) -> str:
    text = EMAIL_RE.sub("[REDACTED_EMAIL]", text)
    text = PHONE_RE.sub("[REDACTED_PHONE]", text)
    return text
```
  
Gunakan dalam ejen:  
```python
from infra.redact import sanitize
# user_goal = sanitize(user_goal)
# context = sanitize(context)
```
  

Langkah 4) Pemutus litar dan pengendalian ralat  
- Bungkus setiap panggilan ejen dengan try/except dan backoff eksponen  
- Hentikan pipeline pada kegagalan berulang  

```python
import time

def with_retry(func, retries=3, base_delay=0.5):
    for i in range(retries):
        try:
            return func()
        except Exception as e:
            if i == retries - 1:
                raise
            time.sleep(base_delay * (2 ** i))
```
  

Langkah 5) Jejak audit tempatan dan eksport  
- Simpan log JSON di bawah `./agent_logs`  
- Mampatkan dan putar log secara berkala  
- Eksport ringkasan untuk ulasan (bilangan, purata latensi, kadar ralat)  

Langkah 6) Semak silang dengan dokumentasi Microsoft Learn  
- Foundry Local menyediakan API yang serasi dengan OpenAI (disahkan dengan `curl /v1/models`)  
- Gunakan `foundry model run <name>` untuk mengesahkan ketersediaan model  
- Ikuti panduan rasmi untuk integrasi klien dan aplikasi contoh (Open WebUI/cara-cara)  

Rujukan:
- Foundry Local (Learn): https://learn.microsoft.com/en-us/azure/ai-foundry/foundry-local/
- Cara-cara Open WebUI: https://learn.microsoft.com/en-us/azure/ai-foundry/foundry-local/how-to/how-to-chat-application-with-open-web-ui
- Contoh panggilan fungsi: https://github.com/microsoft/Foundry-Local/tree/main/samples/python/functioncalling

## Langkah Seterusnya
- Terokai Azure AI Agents untuk orkestrasi yang dihoskan di awan
- Tambahkan penyambung perusahaan (Microsoft Graph, Carian, pangkalan data)

---


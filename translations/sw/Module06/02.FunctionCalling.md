<!--
CO_OP_TRANSLATOR_METADATA:
{
  "original_hash": "8b05633cf46af274b3724ee2f7140100",
  "translation_date": "2025-09-18T16:23:17+00:00",
  "source_file": "Module06/02.FunctionCalling.md",
  "language_code": "sw"
}
-->
# Sehemu02: Kuita Kazi katika Small Language Models (SLMs)

## Jedwali la Yaliyomo
1. [Kuita Kazi ni Nini?](../../../Module06)
2. [Jinsi Kuita Kazi Kunavyofanya Kazi](../../../Module06)
3. [Matumizi ya Kuita Kazi](../../../Module06)
4. [Kuweka Kuita Kazi na Phi-4-mini na Ollama](../../../Module06)
5. [Kufanya Kazi na Qwen3 Function Calling](../../../Module06)
6. [Muunganisho wa Foundry Local](../../../Module06)
7. [Mbinu Bora na Utatuzi wa Matatizo](../../../Module06)
8. [Mifano ya Juu](../../../Module06)

## Kuita Kazi ni Nini?

Kuita kazi ni uwezo wenye nguvu unaoruhusu Small Language Models (SLMs) kuingiliana na zana za nje, APIs, na huduma. Badala ya kuwa na mipaka ya data ya mafunzo yao, SLMs sasa zinaweza:

- **Kuunganishwa na APIs za nje** (huduma za hali ya hewa, hifadhidata, injini za utafutaji)
- **Kutekeleza kazi maalum** kulingana na maombi ya mtumiaji
- **Kupata taarifa za wakati halisi** kutoka vyanzo mbalimbali
- **Kufanya kazi za hesabu** kupitia zana maalum
- **Kuunganisha operesheni nyingi** kwa kazi ngumu

Uwezo huu hubadilisha SLMs kutoka kwa jenereta za maandishi tuli hadi mawakala wa AI wenye nguvu wanaoweza kutekeleza kazi za ulimwengu halisi.

## Jinsi Kuita Kazi Kunavyofanya Kazi

Mchakato wa kuita kazi hufuata mtiririko wa kazi wa kimfumo:

### 1. Muunganisho wa Zana
- **Zana za Nje**: SLMs zinaweza kuunganishwa na APIs za hali ya hewa, hifadhidata, huduma za wavuti, na mifumo mingine ya nje
- **Ufafanuzi wa Kazi**: Kila zana hufafanuliwa na vigezo maalum, miundo ya pembejeo/mazao, na maelezo
- **Ulinganifu wa API**: Zana zinaunganishwa kupitia interface za kawaida (REST APIs, SDKs, nk.)

### 2. Ufafanuzi wa Kazi
Kazi hufafanuliwa na vipengele vitatu muhimu:
```json
{
  "name": "function_name",
  "description": "Clear description of what the function does",
  "parameters": {
    "parameter_name": {
      "description": "What this parameter represents",
      "type": "data_type",
      "default": "default_value"
    }
  }
}
```

### 3. Kugundua Nia
- **Usindikaji wa Lugha Asilia**: SLM huchambua pembejeo ya mtumiaji ili kuelewa nia
- **Ulinganishaji wa Kazi**: Huamua ni kazi gani zinahitajika kutimiza ombi
- **Uchimbaji wa Vigezo**: Hutambua na kuchimba vigezo vinavyohitajika kutoka kwa ujumbe wa mtumiaji

### 4. Uzalishaji wa JSON
SLM huzalisha JSON iliyopangwa yenye:
- Jina la kazi ya kuita
- Vigezo vinavyohitajika na maadili sahihi
- Muktadha wa utekelezaji na metadata

### 5. Utekelezaji wa Nje
- **Uthibitishaji wa Vigezo**: Kuhakikisha vigezo vyote vinavyohitajika vipo na vimeundwa kwa usahihi
- **Utekelezaji wa Kazi**: Programu hutekeleza kazi maalum na vigezo vilivyotolewa
- **Utunzaji wa Makosa**: Kusimamia kushindwa, muda wa kutolewa, na majibu yasiyo sahihi

### 6. Muunganisho wa Majibu
- **Usindikaji wa Matokeo**: Matokeo ya kazi yanarejeshwa kwa SLM
- **Muunganisho wa Muktadha**: SLM hujumuisha matokeo katika majibu yake
- **Mawasiliano na Mtumiaji**: Huonyesha taarifa kwa mtindo wa mazungumzo wa asili

## Matumizi ya Kuita Kazi

### Upataji wa Data
Kubadilisha maswali ya lugha asilia kuwa miito ya API iliyopangwa:
- **"Onyesha maagizo yangu ya hivi karibuni"** → Ombi la hifadhidata na kitambulisho cha mtumiaji na vichujio vya tarehe
- **"Hali ya hewa Tokyo iko vipi?"** → Ombi la API ya hali ya hewa na kigezo cha eneo
- **"Tafuta barua pepe kutoka kwa John wiki iliyopita"** → Ombi la huduma ya barua pepe na mtumaji na vichujio vya tarehe

### Utekelezaji wa Operesheni
Kubadilisha maombi ya mtumiaji kuwa miito maalum ya kazi:
- **"Panga mkutano kwa kesho saa 2 PM"** → Muunganisho wa API ya kalenda
- **"Tuma ujumbe kwa timu"** → API ya jukwaa la mawasiliano
- **"Unda nakala ya faili zangu"** → Operesheni ya mfumo wa faili

### Kazi za Hesabu
Kushughulikia operesheni ngumu za kihesabu au kimantiki:
- **"Hesabu riba ya kiwanja kwa $10,000 kwa 5% kwa miaka 10"** → Kazi ya hesabu ya kifedha
- **"Chambua seti hii ya data kwa mwenendo"** → Zana za uchambuzi wa takwimu
- **"Boresha njia hii kwa usafirishaji"** → Algorithms za uboreshaji wa njia

### Mtiririko wa Usindikaji wa Data
Kuunganisha miito mingi ya kazi kwa operesheni ngumu:
1. **Pata data** kutoka vyanzo mbalimbali
2. **Chambua na thibitisha** taarifa
3. **Badilisha** data kuwa muundo unaohitajika
4. **Hifadhi matokeo** katika mifumo inayofaa
5. **Zalisha ripoti** au taswira

### Muunganisho wa UI/UX
Kuwezesha masasisho ya interface ya nguvu:
- **"Onyesha data ya mauzo kwenye dashibodi"** → Uzalishaji wa chati na maonyesho
- **"Sasisha ramani na maeneo mapya"** → Muunganisho wa data ya kijiografia
- **"Fanya upya maonyesho ya hesabu"** → Usawazishaji wa data wa wakati halisi

## Kuweka Kuita Kazi na Phi-4-mini na Ollama

Phi-4-mini ya Microsoft inaunga mkono miito ya kazi ya moja na sambamba kupitia Ollama. Hivi ndivyo unavyoweza kuiweka:

### Mahitaji ya Awali
- Toleo la Ollama 0.5.13 au zaidi
- Modeli ya Phi-4-mini (inayopendekezwa: `phi4-mini:3.8b-fp16`)

### Hatua za Usakinishaji

#### 1. Sakinisha na Endesha Phi-4-mini
```bash
# Download the model (if not already present)
ollama run phi4-mini:3.8b-fp16

# Verify the model is available
ollama list
```

#### 2. Unda Kiolezo cha ModelFile Maalum
Kwa sababu ya vizuizi vya sasa katika violezo vya chaguo-msingi vya Ollama, unahitaji kuunda ModelFile maalum na kiolezo kifuatacho:

```modelfile
TEMPLATE """
{{- if .Messages }}
{{- if or .System .Tools }}<|system|>
{{ if .System }}{{ .System }}
{{- end }}
In addition to plain text responses, you can chose to call one or more of the provided functions.
Use the following rule to decide when to call a function:
* if the response can be generated from your internal knowledge (e.g., as in the case of queries like "What is the capital of Poland?"), do so
* if you need external information that can be obtained by calling one or more of the provided functions, generate a function calls
If you decide to call functions:
* prefix function calls with functools marker (no closing marker required)
* all function calls should be generated in a single JSON list formatted as functools[{"name": [function name], "arguments": [function arguments as JSON]}, ...]
* follow the provided JSON schema. Do not hallucinate arguments or values. Do to blindly copy values from the provided samples
* respect the argument type formatting. E.g., if the type if number and format is float, write value 7 as 7.0
* make sure you pick the right functions that match the user intent
Available functions as JSON spec:
{{- if .Tools }}
{{ .Tools }}
{{- end }}<|end|>
{{- end }}
{{- range .Messages }}
{{- if ne .Role "system" }}<|{{ .Role }}|>
{{- if and .Content (eq .Role "tools") }}
{"result": {{ .Content }}}
{{- else if .Content }}
{{ .Content }}
{{- else if .ToolCalls }}
functools[
{{- range .ToolCalls }}{{ "{" }}"name": "{{ .Function.Name }}", "arguments": {{ .Function.Arguments }}{{ "}" }}
{{- end }}]
{{- end }}<|end|>
{{- end }}
{{- end }}<|assistant|>
{{ else }}
{{- if .System }}<|system|>
{{ .System }}<|end|>{{ end }}{{ if .Prompt }}<|user|>
{{ .Prompt }}<|end|>{{ end }}<|assistant|>
{{ end }}{{ .Response }}{{ if .Response }}<|user|>{{ end }}
"""
```

#### 3. Unda Modeli Maalum
```bash
# Save the template above as 'Modelfile' and run:
ollama create phi4-mini-fc:3.8b-fp16 -f ./Modelfile
```

### Mfano wa Kuita Kazi Moja

```python
import json
import requests

# Define the tool/function
tools = [
    {
        "name": "get_weather",
        "description": "Get current weather information for a location",
        "parameters": {
            "location": {
                "description": "The city or location name",
                "type": "str",
                "default": "New York"
            },
            "units": {
                "description": "Temperature units (celsius or fahrenheit)",
                "type": "str",
                "default": "celsius"
            }
        }
    }
]

# Create the message with system prompt including tools
messages = [
    {
        "role": "system",
        "content": "You are a helpful weather assistant",
        "tools": json.dumps(tools)
    },
    {
        "role": "user",
        "content": "What's the weather like in London today?"
    }
]

# Make request to Ollama API
response = requests.post(
    "http://localhost:11434/api/chat",
    json={
        "model": "phi4-mini-fc:3.8b-fp16",
        "messages": messages,
        "stream": False
    }
)

print(response.json())
```

### Mfano wa Kuita Kazi Sambamba

```python
import json
import requests

# Define multiple tools for parallel execution
AGENT_TOOLS = {
    "booking_flight": {
        "name": "booking_flight",
        "description": "Book a flight ticket",
        "parameters": {
            "departure": {
                "description": "Departure airport code",
                "type": "str"
            },
            "destination": {
                "description": "Destination airport code", 
                "type": "str"
            },
            "outbound_date": {
                "description": "Departure date (YYYY-MM-DD)",
                "type": "str"
            },
            "return_date": {
                "description": "Return date (YYYY-MM-DD)",
                "type": "str"
            }
        }
    },
    "booking_hotel": {
        "name": "booking_hotel",
        "description": "Book a hotel room",
        "parameters": {
            "city": {
                "description": "City name for hotel booking",
                "type": "str"
            },
            "check_in_date": {
                "description": "Check-in date (YYYY-MM-DD)",
                "type": "str"
            },
            "check_out_date": {
                "description": "Check-out date (YYYY-MM-DD)",
                "type": "str"
            }
        }
    }
}

SYSTEM_PROMPT = """
You are my travel agent with some tools available.
"""

messages = [
    {
        "role": "system",
        "content": SYSTEM_PROMPT,
        "tools": json.dumps(AGENT_TOOLS)
    },
    {
        "role": "user", 
        "content": "I need to travel from London to New York from March 21 2025 to March 27 2025. Please book both flight and hotel."
    }
]

# The model will generate parallel function calls
response = requests.post(
    "http://localhost:11434/api/chat",
    json={
        "model": "phi4-mini-fc:3.8b-fp16",
        "messages": messages,
        "stream": False
    }
)

print(response.json())
```

## Kufanya Kazi na Qwen3 Function Calling

Qwen3 inatoa uwezo wa juu wa kuita kazi na utendaji bora na kubadilika. Hivi ndivyo unavyoweza kuitekeleza:

### Kutumia Mfumo wa Qwen-Agent

Qwen-Agent hutoa mfumo wa kiwango cha juu unaorahisisha utekelezaji wa kuita kazi:

#### Usakinishaji
```bash
pip install -U "qwen-agent[gui,rag,code_interpreter,mcp]"
```

#### Usanidi wa Msingi

```python
import os
from qwen_agent.agents import Assistant

# Configure the LLM
llm_cfg = {
    'model': 'Qwen3-8B',
    # Option 1: Use Alibaba Model Studio
    'model_type': 'qwen_dashscope',
    'api_key': os.getenv('DASHSCOPE_API_KEY'),
    
    # Option 2: Use local deployment
    # 'model_server': 'http://localhost:8000/v1',
    # 'api_key': 'EMPTY',
    
    # Optional configuration for thinking mode
    'generate_cfg': {
        'thought_in_content': True,  # Include reasoning in response
    }
}

# Define tools using MCP (Model Context Protocol)
tools = [
    {
        'mcpServers': {
            'time': {
                'command': 'uvx',
                'args': ['mcp-server-time', '--local-timezone=Asia/Shanghai']
            },
            'fetch': {
                'command': 'uvx', 
                'args': ['mcp-server-fetch']
            }
        }
    },
    'code_interpreter',  # Built-in code execution tool
]

# Create the assistant
bot = Assistant(llm=llm_cfg, function_list=tools)

# Example usage
messages = [
    {
        'role': 'user', 
        'content': 'What time is it now? Also, fetch the latest news from https://example.com/news'
    }
]

# Generate response with function calling
for response in bot.run(messages=messages):
    print(response)
```

### Utekelezaji wa Kazi Maalum

Unaweza pia kufafanua kazi maalum kwa Qwen3:

```python
import json
from qwen_agent.tools.base import BaseTool

class WeatherTool(BaseTool):
    description = 'Get weather information for a specific location'
    parameters = [
        {
            'name': 'location',
            'type': 'string', 
            'description': 'City or location name',
            'required': True
        },
        {
            'name': 'units',
            'type': 'string',
            'description': 'Temperature units (celsius or fahrenheit)',
            'required': False,
            'default': 'celsius'
        }
    ]
    
    def call(self, params: str, **kwargs) -> str:
        """Execute the weather lookup"""
        params_dict = json.loads(params)
        location = params_dict.get('location')
        units = params_dict.get('units', 'celsius')
        
        # Simulate weather API call
        weather_data = {
            'location': location,
            'temperature': '22°C' if units == 'celsius' else '72°F',
            'condition': 'Partly cloudy',
            'humidity': '65%'
        }
        
        return json.dumps(weather_data)

# Use the custom tool
tools = [WeatherTool()]
bot = Assistant(llm=llm_cfg, function_list=tools)

messages = [{'role': 'user', 'content': 'What\'s the weather in Tokyo?'}]
response = bot.run(messages=messages)
print(list(response)[-1])
```

### Vipengele vya Juu vya Qwen3

#### Udhibiti wa Hali ya Kufikiri
Qwen3 inaunga mkono kubadilisha hali ya kufikiri na isiyo ya kufikiri kwa nguvu:

```python
# Enable thinking mode for complex reasoning
messages = [
    {
        'role': 'user',
        'content': '/think Solve this complex math problem: If a train travels 120 km in 1.5 hours, and another train travels 200 km in 2.5 hours, which train is faster and by how much?'
    }
]

# Disable thinking mode for simple queries
messages = [
    {
        'role': 'user', 
        'content': '/no_think What is the capital of France?'
    }
]
```

#### Kuita Kazi kwa Hatua Nyingi
Qwen3 ni bora katika kuunganisha miito mingi ya kazi:

```python
# Complex workflow example
messages = [
    {
        'role': 'user',
        'content': '''
        I need to prepare for a business meeting:
        1. Check my calendar for conflicts tomorrow
        2. Get weather forecast for the meeting location (San Francisco)
        3. Find recent news about the client company (TechCorp)
        4. Calculate travel time from my office to their headquarters
        '''
    }
]

# Qwen3 will automatically determine the sequence of function calls needed
```

## Muunganisho wa Foundry Local

Foundry Local ya Microsoft hutoa API inayolingana na OpenAI kwa kuendesha modeli kwa faragha na utendaji ulioboreshwa.

### Usanidi na Usakinishaji

#### Windows
Pakua kisakinishi kutoka [ukurasa wa matoleo ya Foundry Local](https://github.com/microsoft/Foundry-Local/releases) na fuata maagizo ya usakinishaji.

#### macOS
```bash
brew tap microsoft/foundrylocal
brew install foundrylocal
```

#### Matumizi ya Msingi

```python
import openai
from foundry_local import FoundryLocalManager

# Initialize with model alias
alias = "phi-3.5-mini"  # Or any supported model
manager = FoundryLocalManager(alias)

# Create OpenAI client pointing to local endpoint
client = openai.OpenAI(
    base_url=manager.endpoint,
    api_key=manager.api_key
)

# Define functions for the model
functions = [
    {
        "name": "calculate_tax",
        "description": "Calculate tax amount based on income and rate",
        "parameters": {
            "type": "object",
            "properties": {
                "income": {
                    "type": "number",
                    "description": "Annual income amount"
                },
                "tax_rate": {
                    "type": "number", 
                    "description": "Tax rate as decimal (e.g., 0.25 for 25%)"
                }
            },
            "required": ["income", "tax_rate"]
        }
    }
]

# Make function calling request
response = client.chat.completions.create(
    model=manager.model_info.id,
    messages=[
        {
            "role": "user",
            "content": "Calculate the tax for someone earning $75,000 with a 22% tax rate"
        }
    ],
    functions=functions,
    function_call="auto"
)

print(response.choices[0].message.content)
```

### Vipengele vya Juu vya Foundry Local

#### Usimamizi wa Modeli
```bash
# List available models
foundry model list

# Download specific model
foundry model download phi-3.5-mini

# Run model interactively
foundry model run phi-3.5-mini

# Remove model from cache
foundry model remove phi-3.5-mini

# Delete all cached models
foundry model remove "*"
```

#### Uboreshaji wa Utendaji
Foundry Local huchagua kiotomatiki toleo bora la modeli kwa vifaa vyako:
- **CUDA GPU**: Inapakua modeli zilizoboreshwa kwa GPU
- **Qualcomm NPU**: Hutumia varianiti zilizoharakishwa na NPU
- **CPU pekee**: Huchagua modeli zilizoboreshwa kwa CPU

## Mbinu Bora na Utatuzi wa Matatizo

### Mbinu Bora za Ufafanuzi wa Kazi

#### 1. Upeanaji wa Majina Wazi na Maelezo
```python
# Good
{
    "name": "get_stock_price",
    "description": "Retrieve current stock price for a given symbol"
}

# Avoid
{
    "name": "get_data", 
    "description": "Gets data"
}
```

#### 2. Ufafanuzi wa Vigezo wa Kina
```python
{
    "name": "send_email",
    "description": "Send an email message to specified recipients",
    "parameters": {
        "to": {
            "type": "array",
            "items": {"type": "string"},
            "description": "List of recipient email addresses",
            "required": True
        },
        "subject": {
            "type": "string",
            "description": "Email subject line",
            "required": True
        },
        "body": {
            "type": "string", 
            "description": "Email message content",
            "required": True
        },
        "priority": {
            "type": "string",
            "enum": ["low", "normal", "high"],
            "description": "Email priority level",
            "default": "normal",
            "required": False
        }
    }
}
```

#### 3. Uthibitishaji wa Pembejeo na Utunzaji wa Makosa
```python
def execute_function(function_name, parameters):
    try:
        # Validate required parameters
        if function_name == "send_email":
            if not parameters.get("to") or not parameters.get("subject"):
                return {"error": "Missing required parameters: to, subject"}
            
            # Validate email format
            email_pattern = r'^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'
            for email in parameters["to"]:
                if not re.match(email_pattern, email):
                    return {"error": f"Invalid email format: {email}"}
        
        # Execute function logic
        result = perform_actual_function(function_name, parameters)
        return {"success": True, "data": result}
        
    except Exception as e:
        return {"error": str(e)}
```

### Masuala ya Kawaida na Suluhisho

#### Tatizo 1: Kazi Haijaitwa
**Dalili**: Modeli inajibu kwa maandishi badala ya kuita kazi

**Suluhisho**:
1. **Angalia maelezo ya kazi**: Hakikisha yanaendana wazi na nia ya mtumiaji
2. **Thibitisha ufafanuzi wa vigezo**: Hakikisha vigezo vyote vinavyohitajika vimefafanuliwa vizuri
3. **Kagua maelezo ya mfumo**: Jumuisha maagizo wazi kuhusu wakati wa kutumia kazi
4. **Jaribu maombi ya wazi**: Jaribu "Tafadhali tumia kazi ya hali ya hewa kupata data ya London"

#### Tatizo 2: Vigezo Visivyo Sahihi
**Dalili**: Kazi inaitwa na vigezo visivyo sahihi au vinavyokosekana

**Suluhisho**:
1. **Ongeza mifano ya vigezo**: Jumuisha maadili ya sampuli katika maelezo ya vigezo
2. **Tumia vizuizi vya enum**: Punguza maadili ya vigezo kwa chaguo maalum inapowezekana
3. **Tekeleza maadili ya akiba**: Toa chaguo-msingi za busara kwa vigezo vya hiari

```python
{
    "name": "book_restaurant",
    "parameters": {
        "cuisine": {
            "type": "string",
            "enum": ["italian", "chinese", "mexican", "american", "french"],
            "description": "Type of cuisine (example: 'italian' for Italian food)"
        },
        "party_size": {
            "type": "integer",
            "minimum": 1,
            "maximum": 20,
            "description": "Number of people (example: 4 for a family of four)"
        }
    }
}
```

#### Tatizo 3: Kushindwa kwa Kuita Kazi Sambamba
**Dalili**: Kazi moja tu inatekelezwa wakati nyingi zinapaswa kuendeshwa

**Suluhisho**:
1. **Angalia msaada wa modeli**: Hakikisha modeli yako inaunga mkono kuita kazi sambamba
2. **Sasisha maelezo ya mfumo**: Jumuisha "zana kadhaa" au "zana nyingi" katika ujumbe wa mfumo
3. **Tumia matoleo sahihi ya modeli**: Phi-4-mini:3.8b-fp16 inapendekezwa kwa Ollama

#### Tatizo 4: Masuala ya Kiolezo na Ollama
**Dalili**: Kuita kazi hakufanyi kazi na usanidi wa chaguo-msingi wa Ollama

**Suluhisho**:
1. **Tumia ModelFile maalum**: Tumia kiolezo kilichosahihishwa kilichotolewa katika mafunzo haya
2. **Sasisha Ollama**: Hakikisha unatumia toleo la 0.5.13 au zaidi
3. **Angalia kiwango cha quantization ya modeli**: Viwango vya juu vya quantization (Q8_0, fp16) hufanya kazi bora kuliko varianiti zilizo na quantization kubwa

### Uboreshaji wa Utendaji

#### 1. Ubunifu wa Kazi Ufanisi
- **Weka kazi zikiwa na lengo**: Kila kazi inapaswa kuwa na kusudi moja, wazi
- **Punguza utegemezi wa nje**: Punguza miito ya API na maombi ya mtandao inapowezekana
- **Hifadhi matokeo**: Hifadhi data inayoulizwa mara kwa mara ili kuboresha muda wa majibu

#### 2. Operesheni za Kundi na Async
```python
import asyncio
import aiohttp

async def batch_function_calls(function_calls):
    """Execute multiple function calls concurrently"""
    async with aiohttp.ClientSession() as session:
        tasks = []
        for call in function_calls:
            if call["name"] == "fetch_url":
                task = fetch_url_async(session, call["parameters"]["url"])
                tasks.append(task)
        
        results = await asyncio.gather(*tasks)
        return results

async def fetch_url_async(session, url):
    async with session.get(url) as response:
        return await response.text()
```

#### 3. Usimamizi wa Rasilimali
- **Ujumuishaji wa muunganisho**: Tumia tena muunganisho wa hifadhidata na API
- **Kuweka mipaka ya kiwango**: Tekeleza mipaka sahihi ya kiwango kwa APIs za nje
- **Utunzaji wa muda wa kutolewa**: Weka muda wa kutolewa wa busara kwa miito yote ya nje

## Mifano ya Juu

### Mfumo wa Ushirikiano wa Wakala Wengi

```python
import json
from typing import List, Dict
from qwen_agent.agents import Assistant

class MultiAgentSystem:
    def __init__(self):
        # Research Agent
        self.research_agent = Assistant(
            llm={'model': 'Qwen3-8B', 'model_server': 'http://localhost:8000/v1'},
            function_list=[
                {'mcpServers': {'search': {'command': 'uvx', 'args': ['mcp-server-search']}}},
                {'mcpServers': {'fetch': {'command': 'uvx', 'args': ['mcp-server-fetch']}}}
            ]
        )
        
        # Analysis Agent
        self.analysis_agent = Assistant(
            llm={'model': 'Qwen3-8B', 'model_server': 'http://localhost:8000/v1'},
            function_list=['code_interpreter']
        )
        
        # Communication Agent
        self.comm_agent = Assistant(
            llm={'model': 'Qwen3-8B', 'model_server': 'http://localhost:8000/v1'},
            function_list=[self.create_email_tool(), self.create_slack_tool()]
        )
    
    def create_email_tool(self):
        """Custom email sending tool"""
        class EmailTool:
            name = "send_email"
            description = "Send email to specified recipients"
            parameters = {
                "to": {"type": "string", "description": "Recipient email"},
                "subject": {"type": "string", "description": "Email subject"},
                "body": {"type": "string", "description": "Email content"}
            }
            
            def call(self, params):
                # Implement actual email sending logic
                return f"Email sent successfully to {params['to']}"
        
        return EmailTool()
    
    def create_slack_tool(self):
        """Custom Slack messaging tool"""  
        class SlackTool:
            name = "send_slack"
            description = "Send message to Slack channel"
            parameters = {
                "channel": {"type": "string", "description": "Slack channel"},
                "message": {"type": "string", "description": "Message content"}
            }
            
            def call(self, params):
                # Implement actual Slack API call
                return f"Message sent to {params['channel']}"
        
        return SlackTool()
    
    async def process_complex_request(self, user_request: str):
        """Process complex multi-step requests using multiple agents"""
        
        # Step 1: Research phase
        research_prompt = f"Research the following topic and gather relevant information: {user_request}"
        research_results = []
        for response in self.research_agent.run([{'role': 'user', 'content': research_prompt}]):
            research_results.append(response)
        
        # Step 2: Analysis phase
        analysis_prompt = f"Analyze the following research data and provide insights: {research_results[-1]}"
        analysis_results = []
        for response in self.analysis_agent.run([{'role': 'user', 'content': analysis_prompt}]):
            analysis_results.append(response)
        
        # Step 3: Communication phase
        comm_prompt = f"Create a summary report and send it via email: {analysis_results[-1]}"
        comm_results = []
        for response in self.comm_agent.run([{'role': 'user', 'content': comm_prompt}]):
            comm_results.append(response)
        
        return {
            'research': research_results[-1],
            'analysis': analysis_results[-1], 
            'communication': comm_results[-1]
        }

# Usage example
async def main():
    system = MultiAgentSystem()
    
    request = """
    Analyze the impact of remote work on productivity in tech companies. 
    Research recent studies, analyze the data, and send a summary to our team.
    """
    
    results = await system.process_complex_request(request)
    print("Multi-agent processing complete:", results)

# Run the example
# asyncio.run(main())
```

### Mfumo wa Uchaguzi wa Zana wa Nguvu

```python
class DynamicToolSelector:
    def __init__(self):
        self.available_tools = {
            'weather': {
                'description': 'Get weather information',
                'domains': ['weather', 'temperature', 'forecast', 'climate'],
                'function': self.get_weather
            },
            'calculator': {
                'description': 'Perform mathematical calculations',
                'domains': ['math', 'calculate', 'compute', 'arithmetic'],
                'function': self.calculate
            },
            'web_search': {
                'description': 'Search the internet for information',
                'domains': ['search', 'find', 'lookup', 'research'],
                'function': self.web_search
            },
            'file_manager': {
                'description': 'Manage files and directories',
                'domains': ['file', 'directory', 'save', 'load', 'delete'],
                'function': self.manage_files
            }
        }
    
    def analyze_intent(self, user_input: str) -> List[str]:
        """Analyze user input to determine which tools might be needed"""
        user_words = user_input.lower().split()
        relevant_tools = []
        
        for tool_name, tool_info in self.available_tools.items():
            for domain in tool_info['domains']:
                if domain in user_words:
                    relevant_tools.append(tool_name)
                    break
        
        return relevant_tools
    
    def get_tool_definitions(self, tool_names: List[str]) -> List[Dict]:
        """Generate function definitions for selected tools"""
        definitions = []
        
        for tool_name in tool_names:
            if tool_name == 'weather':
                definitions.append({
                    'name': 'get_weather',
                    'description': 'Get current weather information',
                    'parameters': {
                        'location': {'type': 'string', 'description': 'City or location name'},
                        'units': {'type': 'string', 'enum': ['celsius', 'fahrenheit'], 'default': 'celsius'}
                    }
                })
            elif tool_name == 'calculator':
                definitions.append({
                    'name': 'calculate',
                    'description': 'Perform mathematical calculations',
                    'parameters': {
                        'expression': {'type': 'string', 'description': 'Mathematical expression to evaluate'},
                        'precision': {'type': 'integer', 'default': 2, 'description': 'Decimal places for result'}
                    }
                })
            # Add more tool definitions as needed
        
        return definitions
    
    def get_weather(self, location: str, units: str = 'celsius') -> Dict:
        """Mock weather function"""
        return {
            'location': location,
            'temperature': '22°C' if units == 'celsius' else '72°F',
            'condition': 'Sunny',
            'humidity': '60%'
        }
    
    def calculate(self, expression: str, precision: int = 2) -> Dict:
        """Safe mathematical calculation"""
        try:
            # Simple evaluation for demo - in production, use a proper math parser
            import math
            allowed_names = {
                k: v for k, v in math.__dict__.items() if not k.startswith("__")
            }
            allowed_names.update({"abs": abs, "round": round})
            
            result = eval(expression, {"__builtins__": {}}, allowed_names)
            return {
                'expression': expression,
                'result': round(float(result), precision),
                'success': True
            }
        except Exception as e:
            return {
                'expression': expression,
                'error': str(e),
                'success': False
            }
    
    def web_search(self, query: str, max_results: int = 5) -> Dict:
        """Mock web search function"""
        return {
            'query': query,
            'results': [
                {'title': f'Result {i+1} for {query}', 'url': f'https://example{i+1}.com'}
                for i in range(max_results)
            ]
        }
    
    def manage_files(self, action: str, file_path: str, content: str = None) -> Dict:
        """Mock file management function"""
        return {
            'action': action,
            'file_path': file_path,
            'success': True,
            'message': f'Successfully {action}ed file: {file_path}'
        }

# Usage example
def smart_assistant_with_dynamic_tools():
    selector = DynamicToolSelector()
    
    user_requests = [
        "What's the weather like in New York and calculate 15% tip on $50?",
        "Search for recent AI developments and save the results to a file",
        "Calculate the area of a circle with radius 10 and check weather in Tokyo"
    ]
    
    for request in user_requests:
        print(f"\nUser Request: {request}")
        
        # Analyze which tools might be needed
        relevant_tools = selector.analyze_intent(request)
        print(f"Relevant Tools: {relevant_tools}")
        
        # Get function definitions for the LLM
        tool_definitions = selector.get_tool_definitions(relevant_tools)
        print(f"Tool Definitions: {len(tool_definitions)} functions available")
        
        # In a real implementation, you would pass these to your LLM
        # The LLM would then decide which functions to call and with what parameters

### Enterprise Integration Example

```python
import asyncio
import json
from typing import Dict, List, Any
from dataclasses import dataclass
from datetime import datetime

@dataclass
class FunctionResult:
    """Muundo wa matokeo wa kawaida kwa miito yote ya kazi"""
    success: bool
    data: Any = None
    error: str = None
    execution_time: float = 0.0
    timestamp: datetime = None

class EnterpriseAIAgent:
    """Wakala wa AI wa kiwango cha uzalishaji na uwezo wa kina wa kuita kazi"""
    
    def __init__(self, config: Dict):
        self.config = config
        self.functions = {}
        self.audit_log = []
        self.rate_limiters = {}
        
        # Anzisha kazi za msingi za biashara
        self._register_core_functions()
    
    def _register_core_functions(self):
        """Sajili kazi zote za biashara zinazopatikana"""
        
        # Kazi za CRM
        self.register_function(
            name="get_customer_info",
            description="Pata taarifa za mteja kutoka CRM",
            parameters={
                "customer_id": {"type": "string", "required": True},
                "include_history": {"type": "boolean", "default": False}
            },
            handler=self._get_customer_info,
            rate_limit=100  # miito kwa dakika
        )
        
        # Kazi za Mauzo
        self.register_function(
            name="create_sales_opportunity",
            description="Unda fursa mpya ya mauzo",
            parameters={
                "customer_id": {"type": "string", "required": True},
                "product_id": {"type": "string", "required": True},
                "estimated_value": {"type": "number", "required": True},
                "expected_close_date": {"type": "string", "required": True}
            },
            handler=self._create_sales_opportunity,
            rate_limit=50
        )
        
        # Kazi za Uchambuzi
        self.register_function(
            name="generate_sales_report",
            description="Zalisha ripoti ya utendaji wa mauzo",
            parameters={
                "period": {"type": "string", "enum": ["daily", "weekly", "monthly", "quarterly"]},
                "region": {"type": "string", "required": False},
                "product_category": {"type": "string", "required": False}
            },
            handler=self._generate_sales_report,
            rate_limit=10
        )
        
        # Kazi za Arifa
        self.register_function(
            name="send_notification",
            description="Tuma arifa kwa wanachama wa timu",
            parameters={
                "recipients": {"type": "array", "items": {"type": "string"}},
                "message": {"type": "string", "required": True},
                "priority": {"type": "string", "enum": ["low", "medium", "high"], "default": "medium"},
                "channel": {"type": "string", "enum": ["email", "slack", "teams"], "default": "email"}
            },
            handler=self._send_notification,
            rate_limit=200
        )
    
    def register_function(self, name: str, description: str, parameters: Dict, 
                         handler: callable, rate_limit: int = 60):
        """Sajili kazi mpya na wakala"""
        self.functions[name] = {
            'description': description,
            'parameters': parameters,
            'handler': handler,
            'rate_limit': rate_limit,
            'call_count': 0,
            'last_reset': datetime.now()
        }
    
    async def execute_function(self, function_name: str, parameters: Dict) -
Samahani, tafadhali weka faili ya Markdown unayotaka kutafsiri ili niweze kusaidia.
"""Tekeleza kazi kwa kushughulikia makosa na kuweka kumbukumbu kwa kina"""
start_time = datetime.now()

try:
    # Hakikisha kazi ipo
    if function_name not in self.functions:
        return FunctionResult(
            success=False,
            error=f"Kazi '{function_name}' haikupatikana",
            timestamp=start_time
        )
    
    # Angalia mipaka ya matumizi
    if not self._check_rate_limit(function_name):
        return FunctionResult(
            success=False,
            error=f"Umezidi kiwango cha matumizi kwa kazi '{function_name}'",
            timestamp=start_time
        )
    
    # Hakiki vigezo
    validation_result = self._validate_parameters(function_name, parameters)
    if not validation_result.success:
        return validation_result
    
    # Tekeleza kazi
    func_info = self.functions[function_name]
    handler = func_info['handler']
    
    if asyncio.iscoroutinefunction(handler):
        result_data = await handler(**parameters)
    else:
        result_data = handler(**parameters)
    
    execution_time = (datetime.now() - start_time).total_seconds()
    
    result = FunctionResult(
        success=True,
        data=result_data,
        execution_time=execution_time,
        timestamp=start_time
    )
    
    # Weka kumbukumbu ya utekelezaji uliofanikiwa
    self._log_function_call(function_name, parameters, result)
    
    return result
    
except Exception as e:
    execution_time = (datetime.now() - start_time).total_seconds()
    result = FunctionResult(
        success=False,
        error=str(e),
        execution_time=execution_time,
        timestamp=start_time
    )
    
    # Weka kumbukumbu ya utekelezaji ulioshindwa
    self._log_function_call(function_name, parameters, result)
    
    return result

def _check_rate_limit(self, function_name: str) -> bool:
    """Angalia kama matumizi ya kazi yako ndani ya mipaka"""
    func_info = self.functions[function_name]
    now = datetime.now()
    
    # Weka upya hesabu ikiwa dakika imepita
    if (now - func_info['last_reset']).seconds >= 60:
        func_info['call_count'] = 0
        func_info['last_reset'] = now
    
    # Angalia kama iko chini ya kiwango
    if func_info['call_count'] >= func_info['rate_limit']:
        return False
    
    func_info['call_count'] += 1
    return True

def _validate_parameters(self, function_name: str, parameters: Dict) -> FunctionResult:
    """Hakiki vigezo vya kazi"""
    func_params = self.functions[function_name]['parameters']
    
    # Angalia vigezo vinavyohitajika
    for param_name, param_info in func_params.items():
        if param_info.get('required', False) and param_name not in parameters:
            return FunctionResult(
                success=False,
                error=f"Kigezo kinachohitajika hakipo: {param_name}"
            )
    
    # Hakiki aina za vigezo na vizuizi
    for param_name, value in parameters.items():
        if param_name in func_params:
            param_info = func_params[param_name]
            
            # Hakiki aina
            expected_type = param_info.get('type')
            if expected_type == 'string' and not isinstance(value, str):
                return FunctionResult(
                    success=False,
                    error=f"Kigezo '{param_name}' kinapaswa kuwa maandishi"
                )
            elif expected_type == 'number' and not isinstance(value, (int, float)):
                return FunctionResult(
                    success=False,
                    error=f"Kigezo '{param_name}' kinapaswa kuwa namba"
                )
            elif expected_type == 'boolean' and not isinstance(value, bool):
                return FunctionResult(
                    success=False,
                    error=f"Kigezo '{param_name}' kinapaswa kuwa boolean"
                )
            
            # Hakiki thamani za enum
            if 'enum' in param_info and value not in param_info['enum']:
                return FunctionResult(
                    success=False,
                    error=f"Kigezo '{param_name}' kinapaswa kuwa mojawapo ya: {param_info['enum']}"
                )
    
    return FunctionResult(success=True)

def _log_function_call(self, function_name: str, parameters: Dict, result: FunctionResult):
    """Weka kumbukumbu ya matumizi ya kazi kwa madhumuni ya ukaguzi"""
    log_entry = {
        'timestamp': result.timestamp.isoformat(),
        'function_name': function_name,
        'parameters': parameters,
        'success': result.success,
        'execution_time': result.execution_time,
        'error': result.error if not result.success else None
    }
    
    self.audit_log.append(log_entry)
    
    # Kwa hiari andika kwenye mfumo wa nje wa kuweka kumbukumbu
    if self.config.get('enable_external_logging', False):
        self._write_to_external_log(log_entry)

def _write_to_external_log(self, log_entry: Dict):
    """Andika kumbukumbu kwenye mfumo wa nje wa kuweka kumbukumbu"""
    # Utekelezaji utategemea miundombinu yako ya kuweka kumbukumbu
    # Mfano, tuma kwa ELK stack, CloudWatch, nk.
    pass

# Utekelezaji wa Kazi za Biashara
async def _get_customer_info(self, customer_id: str, include_history: bool = False) -> Dict:
    """Pata taarifa za mteja kutoka mfumo wa CRM"""
    # Simulate database/API call
    await asyncio.sleep(0.1)  # Chelewesha mtandao
    
    customer_data = {
        'customer_id': customer_id,
        'name': 'John Doe',
        'email': 'john.doe@example.com',
        'phone': '+1-555-0123',
        'status': 'active',
        'tier': 'premium'
    }
    
    if include_history:
        customer_data['purchase_history'] = [
            {'date': '2024-01-15', 'product': 'Product A', 'amount': 1500},
            {'date': '2024-03-22', 'product': 'Product B', 'amount': 2300}
        ]
    
    return customer_data

async def _create_sales_opportunity(self, customer_id: str, product_id: str, 
                                  estimated_value: float, expected_close_date: str) -> Dict:
    """Unda fursa mpya ya mauzo"""
    # Simulate CRM API call
    await asyncio.sleep(0.2)
    
    opportunity_id = f"OPP-{datetime.now().strftime('%Y%m%d%H%M%S')}"
    
    return {
        'opportunity_id': opportunity_id,
        'customer_id': customer_id,
        'product_id': product_id,
        'estimated_value': estimated_value,
        'expected_close_date': expected_close_date,
        'status': 'open',
        'created_date': datetime.now().isoformat()
    }

async def _generate_sales_report(self, period: str, region: str = None, 
                               product_category: str = None) -> Dict:
    """Tengeneza ripoti ya mauzo ya kina"""
    # Simulate data aggregation
    await asyncio.sleep(0.5)
    
    return {
        'report_id': f"RPT-{datetime.now().strftime('%Y%m%d%H%M%S')}",
        'period': period,
        'region': region,
        'product_category': product_category,
        'total_sales': 125000.00,
        'total_opportunities': 45,
        'conversion_rate': 0.67,
        'top_products': [
            {'product_id': 'PROD-001', 'sales': 45000},
            {'product_id': 'PROD-002', 'sales': 32000}
        ],
        'generated_at': datetime.now().isoformat()
    }

async def _send_notification(self, recipients: List[str], message: str, 
                           priority: str = 'medium', channel: str = 'email') -> Dict:
    """Tuma taarifa kupitia njia iliyochaguliwa"""
    # Simulate notification service call
    await asyncio.sleep(0.1)
    
    notification_id = f"NOTIF-{datetime.now().strftime('%Y%m%d%H%M%S')}"
    
    return {
        'notification_id': notification_id,
        'recipients': recipients,
        'channel': channel,
        'priority': priority,
        'status': 'sent',
        'sent_at': datetime.now().isoformat()
    }

def get_function_definitions(self) -> List[Dict]:
    """Pata maelezo ya kazi zinazofaa kwa OpenAI kwa kazi zote zilizojisajili"""
    definitions = []
    
    for func_name, func_info in self.functions.items():
        definition = {
            'name': func_name,
            'description': func_info['description'],
            'parameters': {
                'type': 'object',
                'properties': {},
                'required': []
            }
        }
        
        for param_name, param_info in func_info['parameters'].items():
            definition['parameters']['properties'][param_name] = {
                'type': param_info['type'],
                'description': param_info.get('description', '')
            }
            
            if 'enum' in param_info:
                definition['parameters']['properties'][param_name]['enum'] = param_info['enum']
            
            if 'default' in param_info:
                definition['parameters']['properties'][param_name]['default'] = param_info['default']
            
            if param_info.get('required', False):
                definition['parameters']['required'].append(param_name)
        
        definitions.append(definition)
    
    return definitions

# Mfano wa Matumizi kwa Ushirikiano wa Biashara
async def enterprise_demo():
    """Onyesha uwezo wa wakala wa AI wa biashara"""
    
    config = {
        'enable_external_logging': True,
        'max_concurrent_functions': 10,
        'default_timeout': 30
    }
    
    agent = EnterpriseAIAgent(config)
    
    # Mfano 1: Usindikaji wa maswali ya wateja
    print("=== Usindikaji wa Maswali ya Wateja ===")
    
    # Pata taarifa za mteja
    result = await agent.execute_function(
        'get_customer_info',
        {'customer_id': 'CUST-12345', 'include_history': True}
    )
    
    if result.success:
        print(f"Taarifa za Mteja Zimepatikana: {result.data['name']}")
        print(f"Muda wa Utekelezaji: {result.execution_time:.3f}s")
    
    # Mfano 2: Uundaji wa fursa za mauzo
    print("\n=== Uundaji wa Fursa za Mauzo ===")
    
    result = await agent.execute_function(
        'create_sales_opportunity',
        {
            'customer_id': 'CUST-12345',
            'product_id': 'PROD-001',
            'estimated_value': 15000.0,
            'expected_close_date': '2025-09-30'
        }
    )
    
    if result.success:
        print(f"Fursa Imeundwa: {result.data['opportunity_id']}")
    
    # Mfano 3: Operesheni za Kundi
    print("\n=== Operesheni za Kundi ===")
    
    tasks = [
        agent.execute_function('generate_sales_report', {'period': 'monthly'}),
        agent.execute_function('send_notification', {
            'recipients': ['manager@company.com'],
            'message': 'Fursa mpya imeundwa',
            'priority': 'high',
            'channel': 'email'
        })
    ]
    
    results = await asyncio.gather(*tasks)
    
    for i, result in enumerate(results):
        if result.success:
            print(f"Kazi {i+1} imekamilika kwa mafanikio")
        else:
            print(f"Kazi {i+1} imeshindwa: {result.error}")
    
    # Onyesha kumbukumbu ya ukaguzi
    print(f"\n=== Kumbukumbu ya Ukaguzi ({len(agent.audit_log)} maingizo) ===")
    for entry in agent.audit_log[-3:]:  # Onyesha maingizo 3 ya mwisho
        print(f"{entry['timestamp']}: {entry['function_name']} - {'SUCCESS' if entry['success'] else 'FAILED'}")

# Endesha demo ya biashara
# asyncio.run(enterprise_demo())
- **Phi-4 Models**: [Hugging Face Collection](https://huggingface.co/collections/microsoft/phi-4-677e9380e514feb5577a40e4)
- **Qwen3 Documentation**: [Official Qwen Documentation](https://qwen.readthedocs.io/)
- **Ollama**: [Official Website](https://ollama.com/)
- **Foundry Local**: [GitHub Repository](https://github.com/microsoft/Foundry-Local)
- **Function Calling Best Practices**: [Hugging Face Guide](https://huggingface.co/docs/hugs/en/guides/function-calling)

Kumbuka kwamba kuita kazi ni uwanja unaoendelea kubadilika, na kufuatilia maendeleo ya hivi karibuni katika mifumo na modeli unazochagua kutakusaidia kujenga mawakala wa AI wenye ufanisi zaidi.


## ➡️ Nini cha kufanya baadaye

- [03: Model Context Protocol (MCP) Integration](./03.IntroduceMCP.md)

---

**Kanusho**:  
Hati hii imetafsiriwa kwa kutumia huduma ya kutafsiri ya AI [Co-op Translator](https://github.com/Azure/co-op-translator). Ingawa tunajitahidi kuhakikisha usahihi, tafadhali fahamu kuwa tafsiri za kiotomatiki zinaweza kuwa na makosa au kutokuwa sahihi. Hati ya asili katika lugha yake ya awali inapaswa kuzingatiwa kama chanzo rasmi. Kwa taarifa muhimu, tafsiri ya kitaalamu ya binadamu inapendekezwa. Hatutawajibika kwa kutoelewana au tafsiri zisizo sahihi zinazotokana na matumizi ya tafsiri hii.
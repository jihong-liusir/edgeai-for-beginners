<!--
CO_OP_TRANSLATOR_METADATA:
{
  "original_hash": "8344ea4f8f563cfa921e09247588a225",
  "translation_date": "2025-10-09T07:02:33+00:00",
  "source_file": "Workshop/scripts/README.md",
  "language_code": "ru"
}
-->
# Скрипты для мастерской

Этот каталог содержит скрипты автоматизации и поддержки, используемые для поддержания качества и согласованности материалов мастерской.

## Содержание

| Файл | Назначение |
|------|-----------|
| `lint_markdown_cli.py` | Проверяет кодовые блоки Markdown на устаревшие команды Foundry Local CLI. |
| `export_benchmark_markdown.py` | Запускает тестирование задержки для нескольких моделей и создает отчеты в формате Markdown + JSON. |

## 1. Линтер CLI-шаблонов для Markdown

`lint_markdown_cli.py` сканирует все `.md` файлы (кроме переводов) на наличие запрещенных шаблонов Foundry Local CLI **внутри огражденных кодовых блоков** (``` ... ```). Информационный текст может упоминать устаревшие команды для исторического контекста.

### Устаревшие шаблоны (запрещены внутри кодовых блоков)

Линтер блокирует устаревшие шаблоны CLI. Используйте современные альтернативы.

### Требуемые замены
| Устаревшее | Используйте вместо |
|------------|--------------------|
| `foundry model chat <a> "..."` | `foundry model run <a> --prompt "..."` |
| `foundry model list --running` | `foundry model list` |
| `foundry model list --cached` | `foundry cache list` |
| `foundry model stats` | Скрипт для тестирования + системные инструменты (`Task Manager`, `nvidia-smi`) |
| `foundry model benchmark` | `samples/session03/benchmark_oss_models.py` |
| `foundry model list --available` | `foundry model list` |

### Коды выхода
| Код | Значение |
|-----|----------|
| 0 | Нарушений не обнаружено |
| 1 | Найдены один или несколько устаревших шаблонов |

### Локальный запуск
Из корневого каталога репозитория (рекомендуется):

Windows (PowerShell):
```powershell
python Workshop\scripts\lint_markdown_cli.py --verbose
```

macOS / Linux:
```bash
python Workshop/scripts/lint_markdown_cli.py --verbose
```

### Хук перед коммитом (опционально)
```bash
echo "python Workshop/scripts/lint_markdown_cli.py" > .git/hooks/pre-commit
chmod +x .git/hooks/pre-commit
```
Блокирует коммиты, содержащие устаревшие шаблоны.

### Интеграция с CI
GitHub Action workflow (`.github/workflows/markdown-cli-lint.yml`) запускает линтер при каждом пуше и pull request в ветки `main` и `Reactor`. Ошибки необходимо исправить перед слиянием.

### Добавление новых устаревших шаблонов
1. Откройте `lint_markdown_cli.py`.
2. Добавьте кортеж `(regex, suggestion)` в список `DEPRECATED`. Используйте raw-строку и включите границы слов `\b`, где это необходимо.
3. Запустите линтер локально, чтобы проверить обнаружение.
4. Сделайте коммит и пуш; CI будет применять новое правило.

Пример добавления:
```python
DEPRECATED.append((r"\\bfoundry\\s+experimental\\s+foo\\b", "Remove experimental foo usage"))
```

### Разрешение пояснительных упоминаний
Поскольку проверяются только огражденные кодовые блоки, вы можете безопасно описывать устаревшие команды в повествовательном тексте. Если вам *необходимо* показать их внутри блока, используйте блок **без** тройных обратных кавычек (например, с отступом или цитатой) или перепишите в псевдоформе.

### Пропуск определенных файлов (расширенные настройки)
При необходимости можно вынести примеры в отдельный файл вне репозитория или переименовать с другим расширением на этапе разработки. Переведенные копии пропускаются автоматически (пути, содержащие `translations`).

### Устранение неполадок
| Проблема | Причина | Решение |
|----------|---------|---------|
| Линтер отмечает строку, которую вы обновили | Слишком широкий шаблон | Уточните шаблон, добавив границы слов (`\b`) или якоря |
| CI не проходит, но локально все работает | Различие в версиях Python или незакоммиченные изменения | Перезапустите локально, убедитесь, что рабочее дерево чистое, проверьте версию Python в workflow (3.11) |
| Нужно временно обойти проверку | Экстренное исправление | Примените исправление сразу после; рассмотрите использование временной ветки и последующего PR (избегайте добавления обходных переключателей) |

### Обоснование
Сохранение документации в соответствии с *текущей* стабильной поверхностью CLI предотвращает трудности на мастерской, избегает путаницы у участников и централизует измерение производительности через поддерживаемые Python-скрипты вместо устаревших CLI-команд.

---
Поддерживается как часть инструментария для обеспечения качества мастерской. Для улучшений (например, автоматическое исправление предложений или генерация HTML-отчетов) откройте issue или отправьте PR.

## 2. Скрипт проверки примеров

`validate_samples.py` проверяет все файлы с примерами на Python на синтаксис, импорты и соответствие лучшим практикам.

### Использование
```bash
# Validate all samples
python scripts/validate_samples.py

# Validate specific session
python scripts/validate_samples.py --session 01

# Verbose mode (includes best practice warnings)
python scripts/validate_samples.py --verbose

# Summary only
python scripts/validate_samples.py --summary
```

### Что проверяется
- ✅ Корректность синтаксиса Python
- ✅ Наличие необходимых импортов
- ✅ Реализация обработки ошибок (в подробном режиме)
- ✅ Использование аннотаций типов (в подробном режиме)
- ✅ Докстринги функций (в подробном режиме)
- ✅ Ссылки на SDK (в подробном режиме)

### Переменные окружения
- `SKIP_IMPORT_CHECK=1` - Пропустить проверку импортов
- `SKIP_SYNTAX_CHECK=1` - Пропустить проверку синтаксиса

### Коды выхода
- `0` - Все примеры прошли проверку
- `1` - Один или несколько примеров не прошли проверку

## 3. Тестовый запуск примеров

`test_samples.py` выполняет тестовые запуски всех примеров, чтобы убедиться, что они работают без ошибок.

### Использование
```bash
# Test all samples
python scripts/test_samples.py

# Test specific session
python scripts/test_samples.py --session 01

# Quick mode (shorter timeouts)
python scripts/test_samples.py --quick

# Verbose mode (show output)
python scripts/test_samples.py --verbose
```

### Предварительные условия
- Запущен сервис Foundry Local: `foundry service start`
- Загружены модели: `foundry model run phi-4-mini`
- Установлены зависимости: `pip install -r requirements.txt`

### Что тестируется
- ✅ Пример выполняется без ошибок времени выполнения
- ✅ Генерируется необходимый вывод
- ✅ Корректная обработка ошибок при сбое
- ✅ Производительность (время выполнения)

### Переменные окружения
- `FOUNDRY_LOCAL_ALIAS=phi-4-mini` - Модель для тестирования
- `TEST_TIMEOUT=30` - Тайм-аут на пример в секундах

### Ожидаемые сбои
Некоторые тесты могут завершиться неудачей, если не установлены дополнительные зависимости (например, `ragas`, `sentence-transformers`). Установите их с помощью:
```bash
pip install sentence-transformers ragas datasets
```

### Коды выхода
- `0` - Все тесты прошли успешно
- `1` - Один или несколько тестов завершились неудачей

## 4. Экспортер результатов тестирования в Markdown

Скрипт: `export_benchmark_markdown.py`

Генерирует воспроизводимую таблицу производительности для набора моделей.

### Использование
```powershell
python Workshop\scripts\export_benchmark_markdown.py --models "qwen2.5-0.5b,gemma-2-2b" --prompt "Explain retrieval augmented generation briefly." --rounds 3 --output benchmark_report.md
```

### Выводы
| Файл | Описание |
|------|----------|
| `benchmark_report.md` | Таблица в формате Markdown (среднее, p95, токены/сек, опционально первый токен) |
| `benchmark_report.json` | Массив метрик для сравнения и истории |

### Опции
| Флаг | Описание | По умолчанию |
|------|----------|--------------|
| `--models` | Список псевдонимов моделей через запятую | (обязательно) |
| `--prompt` | Запрос, используемый в каждом раунде | (обязательно) |
| `--rounds` | Количество раундов на модель | 3 |
| `--output` | Файл вывода в формате Markdown | `benchmark_report.md` |
| `--json` | Файл вывода в формате JSON | `benchmark_report.json` |
| `--fail-on-empty` | Ненулевой код выхода, если все тесты завершились неудачей | выключено |

Переменная окружения `BENCH_STREAM=1` добавляет измерение задержки первого токена.

### Примечания
- Использует `workshop_utils` для согласованной загрузки моделей и кэширования.
- Если скрипт запускается из другого рабочего каталога, он пытается найти `workshop_utils` через резервные пути.
- Для сравнения GPU: выполните один раз, включите ускорение через настройки CLI, выполните повторно и сравните JSON.

---

**Отказ от ответственности**:  
Этот документ был переведен с помощью сервиса автоматического перевода [Co-op Translator](https://github.com/Azure/co-op-translator). Несмотря на наши усилия обеспечить точность, автоматические переводы могут содержать ошибки или неточности. Оригинальный документ на его родном языке следует считать авторитетным источником. Для получения критически важной информации рекомендуется профессиональный перевод человеком. Мы не несем ответственности за любые недоразумения или неправильные интерпретации, возникшие в результате использования данного перевода.
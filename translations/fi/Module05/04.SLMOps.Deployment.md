<!--
CO_OP_TRANSLATOR_METADATA:
{
  "original_hash": "ad0c054ebd3de404d997d1707a513c70",
  "translation_date": "2025-09-18T10:37:36+00:00",
  "source_file": "Module05/04.SLMOps.Deployment.md",
  "language_code": "fi"
}
-->
# Osa 4: K√§ytt√∂√∂notto - Tuotantovalmis mallin toteutus

## Yleiskatsaus

T√§m√§ kattava opas ohjaa sinut l√§pi koko prosessin hienos√§√§dettyjen kvantisoitujen mallien k√§ytt√∂√∂notosta Foundry Localin avulla. K√§ymme l√§pi mallin muunnoksen, kvantisoinnin optimoinnin ja k√§ytt√∂√∂noton konfiguroinnin alusta loppuun.

## Esivaatimukset

Ennen aloittamista varmista, ett√§ sinulla on seuraavat:

- ‚úÖ Hienos√§√§detty ONNX-malli, joka on valmis k√§ytt√∂√∂nottoon
- ‚úÖ Windows- tai Mac-tietokone
- ‚úÖ Python 3.10 tai uudempi
- ‚úÖ V√§hint√§√§n 8GB vapaata RAM-muistia
- ‚úÖ Foundry Local asennettuna j√§rjestelm√§√§si

## Osa 1: Ymp√§rist√∂n asennus

### Tarvittavien ty√∂kalujen asentaminen

Avaa komentorivisi (Command Prompt Windowsissa, Terminal Macissa) ja suorita seuraavat komennot j√§rjestyksess√§:

```bash
# Update transformers library to the latest version
pip install transformers -U

# Install Microsoft Olive (model conversion tool)
pip install git+https://github.com/microsoft/Olive.git

# Install ONNX Runtime GenAI
git clone https://github.com/microsoft/onnxruntime-genai
cd onnxruntime-genai && python build.py --config Release
pip install {Your build release path}/onnxruntime_genai-0.9.0.dev0-cp311-cp311-linux_x86_64.whl

# Install additional dependencies
pip install onnx onnxruntime numpy
```

‚ö†Ô∏è **T√§rke√§ huomautus**: Tarvitset my√∂s CMake-version 3.31 tai uudemman, jonka voit ladata osoitteesta [cmake.org](https://cmake.org/download/).

## Osa 2: Mallin muunnos ja kvantisointi

### Oikean formaatin valinta

Hienos√§√§detyille pienille kielimalleille suosittelemme k√§ytt√§m√§√§n **ONNX-formaattia**, koska se tarjoaa:

- üöÄ Parempaa suorituskyvyn optimointia
- üîß Laiteriippumatonta k√§ytt√∂√∂nottoa
- üè≠ Tuotantovalmiita ominaisuuksia
- üì± Alustojen v√§list√§ yhteensopivuutta

### Menetelm√§ 1: Yhden komennon muunnos (suositeltu)

K√§yt√§ seuraavaa komentoa muuntaaksesi hienos√§√§detyn mallisi suoraan:

```bash
olive auto-opt \
    --model_name_or_path /path/to/your/finetuned/model \
    --device cpu \
    --provider CPUExecutionProvider \
    --use_model_builder \
    --precision int4 \
    --output_path models/your-model-name/onnx \
    --log_level 1
```

**Parametrien selitys:**
- `--model_name_or_path`: Polku hienos√§√§dettyyn malliin
- `--device cpu`: K√§yt√§ CPU:ta optimointiin
- `--precision int4`: K√§yt√§ INT4-kvantisointia (noin 75 % koon pienennys)
- `--output_path`: Muunnetun mallin tallennuspolku

### Menetelm√§ 2: Konfiguraatiotiedoston k√§ytt√∂ (edistyneet k√§ytt√§j√§t)

Luo konfiguraatiotiedosto nimelt√§ `finetuned_conversion_config.json`:

```json
{
    "input_model": {
        "type": "HfModel",
        "model_path": "/path/to/your/finetuned/model",
        "task": "text-generation"
    },
    "systems": {
        "local_system": {
            "type": "LocalSystem",
            "accelerators": [
                {
                    "execution_providers": [
                        "CPUExecutionProvider"
                    ]
                }
            ]
        }
    },
    "passes": {
        "builder": {
            "type": "ModelBuilder",
            "config": {
                "precision": "int4",
                "quantization_config": {
                    "block_size": 128,
                    "is_symmetric": false
                }
            }
        }
    },
    "host": "local_system",
    "target": "local_system",
    "cache_dir": "cache",
    "output_dir": "models/output/your-finetuned-model-onnx"
}
```

Suorita sitten:

```bash
olive run --config ./finetuned_conversion_config.json
```

### Kvantisointivaihtoehtojen vertailu

| Tarkkuus | Tiedoston koko | Inferenssin nopeus | Mallin laatu | Suositeltu k√§ytt√∂ |
|----------|----------------|--------------------|--------------|-------------------|
| FP16     | Perustaso √ó 0.5 | Nopea | Paras | Korkean suorituskyvyn laitteet |
| INT8     | Perustaso √ó 0.25 | Eritt√§in nopea | Hyv√§ | Tasapainoinen valinta |
| INT4     | Perustaso √ó 0.125 | Nopein | Hyv√§ksytt√§v√§ | Rajoitetut resurssit |

üí° **Suositus**: Aloita INT4-kvantisoinnilla ensimm√§isess√§ k√§ytt√∂√∂notossa. Jos laatu ei ole tyydytt√§v√§, kokeile INT8- tai FP16-vaihtoehtoja.

## Osa 3: Foundry Local -k√§ytt√∂√∂noton konfigurointi

### Mallikonfiguraation luominen

Siirry Foundry Localin mallihakemistoon:

```bash
foundry cache cd ./models/
```

Luo mallihakemiston rakenne:

```bash
mkdir -p ./models/custom/your-finetuned-model
```

Luo `inference_model.json`-konfiguraatiotiedosto mallihakemistoon:

```json
{
  "Name": "your-finetuned-model-int4",
  "Description": "Fine-tuned quantized model",
  "Version": "1.0",
  "PromptTemplate": {
    "system": "<|im_start|>system\n{Content}<|im_end|>",
    "user": "<|im_start|>user\n{Content}<|im_end|>",
    "assistant": "<|im_start|>assistant\n{Content}<|im_end|>",
    "prompt": "<|im_start|>user\n{Content}<|im_end|>\n<|im_start|>assistant"
  },
  "ModelConfig": {
    "max_length": 2048,
    "temperature": 0.7,
    "top_p": 0.9,
    "repetition_penalty": 1.1
  }
}
```

### Mallikohtaiset mallipohjakonfiguraatiot

#### Qwen-sarjan malleille:

```json
{
  "Name": "qwen-finetuned-int4",
  "PromptTemplate": {
    "system": "<|im_start|>system\n{Content}<|im_end|>",
    "user": "<|im_start|>user\n{Content}<|im_end|>",
    "assistant": "<|im_start|>assistant\n{Content}<|im_end|>",
    "prompt": "<|im_start|>user\n{Content}<|im_end|>\n<|im_start|>assistant"
  }
}
```

## Osa 4: Mallin testaus ja optimointi

### Mallin asennuksen tarkistaminen

Tarkista, tunnistaako Foundry Local mallisi:

```bash
foundry cache ls
```

Sinun pit√§isi n√§hd√§ `your-finetuned-model-int4` listassa.

### Mallin testauksen aloittaminen

```bash
foundry model run your-finetuned-model-int4
```

### Suorituskyvyn arviointi

Seuraa keskeisi√§ mittareita testauksen aikana:

1. **Vastausaika**: Mittaa keskim√§√§r√§inen aika per vastaus
2. **Muistin k√§ytt√∂**: Seuraa RAM-muistin kulutusta
3. **CPU:n k√§ytt√∂aste**: Tarkista prosessorin kuormitus
4. **Tuloksen laatu**: Arvioi vastausten osuvuus ja johdonmukaisuus

### Laadun validointitarkistuslista

- ‚úÖ Malli vastaa asianmukaisesti hienos√§√§detyn alueen kyselyihin
- ‚úÖ Vastausten muoto vastaa odotettua ulostulorakennetta
- ‚úÖ Ei muistivuotoja pitk√§aikaisessa k√§yt√∂ss√§
- ‚úÖ Johdonmukainen suorituskyky eri sy√∂tteiden pituuksilla
- ‚úÖ Oikea k√§sittely reunatapauksissa ja virheellisiss√§ sy√∂tteiss√§

## Yhteenveto

Onnittelut! Olet onnistuneesti suorittanut:

- ‚úÖ Hienos√§√§detyn mallin formaatin muunnoksen
- ‚úÖ Mallin kvantisoinnin optimoinnin
- ‚úÖ Foundry Local -k√§ytt√∂√∂noton konfiguroinnin
- ‚úÖ Suorituskyvyn hienos√§√§d√∂n ja vianm√§√§rityksen

---

**Vastuuvapauslauseke**:  
T√§m√§ asiakirja on k√§√§nnetty k√§ytt√§m√§ll√§ teko√§lypohjaista k√§√§nn√∂spalvelua [Co-op Translator](https://github.com/Azure/co-op-translator). Vaikka pyrimme tarkkuuteen, huomioithan, ett√§ automaattiset k√§√§nn√∂kset voivat sis√§lt√§√§ virheit√§ tai ep√§tarkkuuksia. Alkuper√§inen asiakirja sen alkuper√§isell√§ kielell√§ tulisi pit√§√§ ensisijaisena l√§hteen√§. Kriittisen tiedon osalta suositellaan ammattimaista ihmisk√§√§nn√∂st√§. Emme ole vastuussa v√§√§rink√§sityksist√§ tai virhetulkinnoista, jotka johtuvat t√§m√§n k√§√§nn√∂ksen k√§yt√∂st√§.
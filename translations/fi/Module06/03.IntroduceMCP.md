<!--
CO_OP_TRANSLATOR_METADATA:
{
  "original_hash": "b6bd5b920b610665fd0462f6b5c2e134",
  "translation_date": "2025-09-18T10:02:30+00:00",
  "source_file": "Module06/03.IntroduceMCP.md",
  "language_code": "fi"
}
-->
# Osa 03 - Model Context Protocol (MCP) -integraatio

## Johdatus MCP:hen (Model Context Protocol)

Model Context Protocol (MCP) on mullistava kehys, joka mahdollistaa kielimallien vuorovaikutuksen ulkoisten työkalujen ja järjestelmien kanssa standardoidulla tavalla. Toisin kuin perinteiset lähestymistavat, joissa mallit ovat eristettyjä, MCP luo sillan tekoälymallien ja todellisen maailman välille hyvin määritellyn protokollan avulla.

### Mikä on MCP?

MCP toimii viestintäprotokollana, joka mahdollistaa kielimallien:
- Yhteyden ulkoisiin tietolähteisiin
- Työkalujen ja toimintojen suorittamisen
- Vuorovaikutuksen API:en ja palveluiden kanssa
- Pääsyn reaaliaikaiseen tietoon
- Monimutkaisten monivaiheisten operaatioiden suorittamisen

Tämä protokolla muuttaa staattiset kielimallit dynaamisiksi agenteiksi, jotka kykenevät suorittamaan käytännön tehtäviä tekstin tuottamisen lisäksi.

## Pienet kielimallit (SLM:t) MCP:ssä

Pienet kielimallit edustavat tehokasta lähestymistapaa tekoälyn käyttöönottoon ja tarjoavat useita etuja:

### SLM:ien edut
- **Resurssitehokkuus**: Vähemmän laskentatehoa vaativat
- **Nopeammat vasteajat**: Vähemmän viivettä reaaliaikaisissa sovelluksissa  
- **Kustannustehokkuus**: Vähäiset infrastruktuurivaatimukset
- **Yksityisyys**: Voidaan ajaa paikallisesti ilman datan siirtoa
- **Mukautettavuus**: Helpompi hienosäätää tiettyjä toimialoja varten

### Miksi SLM:t toimivat hyvin MCP:n kanssa

SLM:t yhdistettynä MCP:hen muodostavat tehokkaan yhdistelmän, jossa mallin päättelykykyä parannetaan ulkoisten työkalujen avulla, kompensoiden pienempää parametrimäärää lisääntyneellä toiminnallisuudella.

## Python MCP SDK:n yleiskatsaus

Python MCP SDK tarjoaa perustan MCP-yhteensopivien sovellusten rakentamiseen. SDK sisältää:

- **Asiakaskirjastot**: MCP-palvelimiin yhdistämiseen
- **Palvelinkehys**: Mukautettujen MCP-palvelimien luomiseen
- **Protokollakäsittelijät**: Viestinnän hallintaan
- **Työkalujen integrointi**: Ulkoisten toimintojen suorittamiseen

## Käytännön toteutus: Phi-4 MCP Client

Tutustutaan todelliseen toteutukseen käyttämällä Microsoftin Phi-4-minimallia, joka on integroitu MCP-ominaisuuksilla.

### Järjestelmäarkkitehtuuri

Toteutus noudattaa kerroksellista arkkitehtuuria:

```
┌─────────────────────────────────────┐
│        Application Layer           │
│  ├── Interactive Loop              │
│  ├── CLI Interface                 │
│  └── Configuration Management      │
└─────────────────────────────────────┘
┌─────────────────────────────────────┐
│         LLM Client Layer           │
│  ├── OllamaClient                  │
│  ├── VLLMClient                    │
│  └── LLMClient (Abstract)          │
└─────────────────────────────────────┘
┌─────────────────────────────────────┐
│        MCP Client Layer            │
│  ├── Phi4MiniMCPClient (STDIO)     │
│  ├── Phi4MiniSSEMCPClient (SSE)    │
│  └── BaseMCPClient (Abstract)      │
└─────────────────────────────────────┘
┌─────────────────────────────────────┐
│      Tool Processing Layer         │
│  ├── ToolCallHandler               │
│  ├── Function Format Transformer   │
│  └── Tool Schema Management        │
└─────────────────────────────────────┘
```

### Keskeiset komponentit

#### 1. MCP-asiakasluokat

**BaseMCPClient**: Abstrakti perusta, joka tarjoaa yleisiä toimintoja
- Asynkroninen kontekstinhallintaprotokolla
- Standardoitu rajapintamäärittely
- Resurssien hallinta

**Phi4MiniMCPClient**: STDIO-pohjainen toteutus
- Paikallinen prosessiviestintä
- Standardoitu syöte-/tulostekäsittely
- Aliprosessien hallinta

**Phi4MiniSSEMCPClient**: Server-Sent Events -toteutus
- HTTP-suoratoistoviestintä
- Reaaliaikainen tapahtumien käsittely
- Verkkopohjainen palvelinyhteys

#### 2. LLM-integraatio

**OllamaClient**: Paikallinen mallin isännöinti
```python
class OllamaClient(LLMClient):
    def __init__(self):
        self.url = "http://localhost:11434/api/chat"
        self.model_id = "phi4-mini:3.8b-fp16"
```

**VLLMClient**: Suorituskykyinen palvelu
```python
class VLLMClient(LLMClient):
    def __init__(self):
        self.url = "http://localhost:8000/v1"
        self.model_id = "microsoft/Phi-4-mini-instruct"
```

#### 3. Työkalujen käsittelyputki

Työkalujen käsittelyputki muuntaa MCP-työkalut kielimallien kanssa yhteensopiviksi muodoiksi:

```python
def transform_functions_format(input_data):
    """Convert MCP tool schemas to LLM-compatible formats"""
    # Maps OpenAPI schemas to function calling schemas
    # Handles parameter type conversion
    # Maintains required field information
```

## Aloittaminen: vaiheittainen opas

### Vaihe 1: Ympäristön asennus

Asenna tarvittavat riippuvuudet:
```bash
pip install fastmcp mcp-python-client openai requests pyautogui Pillow
```

### Vaihe 2: Perusasetukset

Määritä ympäristömuuttujat:
```python
# System Configuration
SYSTEM_PROMPT = "You are an AI assistant with some tools."

# Ollama Configuration (Local)
OLLAMA_URL = "http://localhost:11434/api/chat"
OLLAMA_MODEL_ID = "phi4-mini:3.8b-fp16"

# vLLM Configuration (Server)
VLLM_URL = "http://localhost:8000/v1"
VLLM_MODEL_ID = "microsoft/Phi-4-mini-instruct"
```

### Vaihe 3: Ensimmäisen MCP-asiakkaan suorittaminen

**Perus Ollama-asetus:**
```bash
python ghmodel_mcp_demo.py
```

**vLLM-taustajärjestelmän käyttö:**
```bash
python ghmodel_mcp_demo.py --env vllm
```

**Server-Sent Events -yhteys:**
```bash
python ghmodel_mcp_demo.py --run sse
```

**Mukautettu MCP-palvelin:**
```bash
python ghmodel_mcp_demo.py --server /path/to/server.py
```

### Vaihe 4: Ohjelmallinen käyttö

```python
import asyncio
from ghmodel_mcp_demo import OllamaClient, Phi4MiniMCPClient

async def automated_interaction():
    # Configure MCP server parameters
    server_params = StdioServerParameters(
        command="npx",
        args=["@playwright/mcp@latest"],
        env=None,
    )
    
    # Create MCP client and process tools
    async with Phi4MiniMCPClient(server_params) as mcp_client:
        tools = await process_mcp_tools(mcp_client)
        llm_client = OllamaClient()
        
        # Generate response with tool capabilities
        response, messages = await llm_client.generate_response(
            "Help me automate a web task",
            tools
        )
        return response

# Execute the automation
result = asyncio.run(automated_interaction())
print(result)
```

## Edistyneet ominaisuudet

### Monitaustajärjestelmän tuki

Toteutus tukee sekä Ollama- että vLLM-taustajärjestelmiä, jolloin voit valita tarpeidesi mukaan:

- **Ollama**: Parempi paikalliseen kehitykseen ja testaukseen
- **vLLM**: Optimoitu tuotantoon ja suurten läpimenoaikojen skenaarioihin

### Joustavat yhteysprotokollat

Kaksi yhteystilaa ovat tuettuja:

**STDIO-tila**: Suora prosessiviestintä
- Vähemmän viivettä
- Sopii paikallisille työkaluille
- Yksinkertainen asennus

**SSE-tila**: HTTP-pohjainen suoratoisto
- Verkkokykyinen
- Parempi hajautetuille järjestelmille
- Reaaliaikaiset päivitykset

### Työkalujen integrointikyvyt

Järjestelmä voi integroitua erilaisiin työkaluihin:
- Verkkoselainautomaatio (Playwright)
- Tiedosto-operaatiot
- API-vuorovaikutukset
- Järjestelmäkomennot
- Mukautetut toiminnot

## Virheenkäsittely ja parhaat käytännöt

### Kattava virhehallinta

Toteutus sisältää vahvan virheenkäsittelyn seuraaville:

**Yhteysvirheet:**
- MCP-palvelimen toimintahäiriöt
- Verkkoyhteyden aikakatkaisut
- Yhteysongelmat

**Työkalujen suoritusvirheet:**
- Puuttuvat työkalut
- Parametrien validointi
- Suoritusvirheet

**Vastauskäsittelyvirheet:**
- JSON-jäsennysongelmat
- Muotoepäjohdonmukaisuudet
- LLM-vastausanomaliat

### Parhaat käytännöt

1. **Resurssien hallinta**: Käytä asynkronisia kontekstinhallintatyökaluja
2. **Virheenkäsittely**: Toteuta kattavat try-catch-lohkot
3. **Lokitus**: Ota käyttöön sopivat lokitustasot
4. **Turvallisuus**: Validoi syötteet ja puhdista tulosteet
5. **Suorituskyky**: Käytä yhteyspoolia ja välimuistia

## Käytännön sovellukset

### Verkkoselainautomaatio
```python
# Example: Automated web testing
async def web_automation_example():
    tools = await setup_playwright_tools()
    response = await llm_client.generate_response(
        "Navigate to example.com and take a screenshot",
        tools
    )
```

### Tiedonkäsittely
```python
# Example: File analysis
async def data_processing_example():
    tools = await setup_file_tools()
    response = await llm_client.generate_response(
        "Analyze the CSV file and generate a summary report",
        tools
    )
```

### API-integraatio
```python
# Example: API interactions
async def api_integration_example():
    tools = await setup_api_tools()
    response = await llm_client.generate_response(
        "Fetch weather data and create a forecast summary",
        tools
    )
```

## Suorituskyvyn optimointi

### Muistinhallinta
- Tehokas viestihistorian käsittely
- Asianmukainen resurssien siivous
- Yhteyspoolin käyttö

### Verkkoyhteyden optimointi
- Asynkroniset HTTP-operaatiot
- Konfiguroitavat aikakatkaisut
- Sulava virheiden palautus

### Samanaikainen käsittely
- Ei-blokkaava I/O
- Työkalujen rinnakkainen suoritus
- Tehokkaat asynkroniset mallit

## Turvallisuushuomiot

### Tietosuoja
- API-avainten turvallinen hallinta
- Syötteiden validointi
- Tulosteiden puhdistus

### Verkkoturvallisuus
- HTTPS-tuki
- Paikalliset päätepisteet oletuksena
- Turvallinen tunnusten käsittely

### Suorituskyvyn turvallisuus
- Työkalujen suodatus
- Eristetyt ympäristöt
- Lokitietojen auditointi

## Yhteenveto

SLM:t integroituna MCP:hen edustavat paradigman muutosta tekoälysovellusten kehityksessä. Yhdistämällä pienten mallien tehokkuus ulkoisten työkalujen voimaan kehittäjät voivat luoda älykkäitä järjestelmiä, jotka ovat sekä resurssitehokkaita että erittäin kyvykkäitä.

Phi-4 MCP -asiakastoteutus osoittaa, kuinka tämä integraatio voidaan saavuttaa käytännössä, tarjoten vankan perustan kehittyneiden tekoälypohjaisten sovellusten rakentamiseen.

Keskeiset opit:
- MCP yhdistää kielimallit ja ulkoiset järjestelmät
- SLM:t tarjoavat tehokkuutta ilman toiminnallisuuden menetystä, kun niitä täydennetään työkaluilla
- Modulaarinen arkkitehtuuri mahdollistaa helpon laajennettavuuden ja mukauttamisen
- Asianmukainen virheenkäsittely ja turvallisuustoimenpiteet ovat välttämättömiä tuotantokäytössä

Tämä opas tarjoaa perustan omien SLM-pohjaisten MCP-sovellusten rakentamiseen, avaten mahdollisuuksia automaatioon, tiedonkäsittelyyn ja älykkäiden järjestelmien integrointiin.

---

**Vastuuvapauslauseke**:  
Tämä asiakirja on käännetty käyttämällä tekoälypohjaista käännöspalvelua [Co-op Translator](https://github.com/Azure/co-op-translator). Pyrimme tarkkuuteen, mutta huomioithan, että automaattiset käännökset voivat sisältää virheitä tai epätarkkuuksia. Alkuperäistä asiakirjaa sen alkuperäisellä kielellä tulee pitää ensisijaisena lähteenä. Kriittisen tiedon osalta suositellaan ammattimaista ihmiskääntämistä. Emme ole vastuussa tämän käännöksen käytöstä johtuvista väärinkäsityksistä tai virhetulkinnoista.